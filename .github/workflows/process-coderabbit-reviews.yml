name: Process CodeRabbit Reviews

on:
  # Only trigger on the main summary comment, not individual inline comments
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

# Only one workflow run per PR at a time
concurrency:
  group: coderabbit-fix-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  process-coderabbit-review:
    # Run only on the MAIN SUMMARY comment from CodeRabbit
    # This comment contains "Actionable comments posted: N"
    # Ignore individual inline review comments to avoid multiple PRs
    if: |
      (github.event.comment.user.login == 'coderabbitai[bot]' ||
       github.event.comment.user.login == 'coderabbit[bot]') &&
      contains(github.event.comment.body, 'Actionable comments posted:')

    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

    steps:
      # ============================================
      # PHASE 1: Extract CodeRabbit AI Prompt
      # ============================================
      - name: Get PR Information
        id: pr_info
        run: |
          # For issue_comment, we need to get PR details from the issue
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            PR_NUMBER="${{ github.event.issue.number }}"
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          # Get PR details using GitHub API
          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER)
          HEAD_REF=$(echo "$PR_DATA" | jq -r '.head.ref')
          HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')
          BASE_REF=$(echo "$PR_DATA" | jq -r '.base.ref')

          echo "head_ref=$HEAD_REF" >> $GITHUB_OUTPUT
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT
          echo "base_ref=$BASE_REF" >> $GITHUB_OUTPUT

          echo "üìã PR #$PR_NUMBER"
          echo "üåø Feature Branch: $HEAD_REF"
          echo "üéØ Base Branch: $BASE_REF"

      - name: Checkout Feature Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr_info.outputs.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch All CodeRabbit Review Comments
        id: extract
        env:
          PR_NUMBER: ${{ steps.pr_info.outputs.pr_number }}
        run: |
          echo "üîç Fetching all CodeRabbit review comments..."

          # Fetch all review comments on this PR
          gh api repos/${{ github.repository }}/pulls/${PR_NUMBER}/comments \
            --paginate \
            --jq '.[] | select(.user.login == "coderabbitai[bot]" or .user.login == "coderabbit[bot]")' \
            > /tmp/all_comments.json

          # Count comments
          COMMENT_COUNT=$(cat /tmp/all_comments.json | jq -s 'length')
          echo "üìä Found $COMMENT_COUNT CodeRabbit review comments"

          if [ "$COMMENT_COUNT" -eq "0" ]; then
            echo "‚ö†Ô∏è No CodeRabbit review comments found"
            echo "has_prompt=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract all AI prompts from the comments
          echo "# CodeRabbit Review Issues" > /tmp/ai_prompt.txt
          echo "" >> /tmp/ai_prompt.txt

          ISSUE_NUM=1
          cat /tmp/all_comments.json | jq -rs '.[] | .body' | while IFS= read -r COMMENT_BODY; do
            # Extract file path and line info if available
            FILE_PATH=$(echo "$COMMENT_BODY" | grep -oP '(?<=`)[^`]+\.(js|ts|py|go|java|rb|rs|cpp|c|h)[^`]*(?=`)' | head -1 || echo "")

            # Extract the AI prompt section
            AI_PROMPT=$(echo "$COMMENT_BODY" | \
              awk '/Prompt for AI Agents/,/```$/' | \
              sed -n '/```/,/```/p' | \
              sed '1d;$d')

            if [ -n "$AI_PROMPT" ]; then
              echo "## Issue $ISSUE_NUM" >> /tmp/ai_prompt.txt
              if [ -n "$FILE_PATH" ]; then
                echo "File: $FILE_PATH" >> /tmp/ai_prompt.txt
              fi
              echo "" >> /tmp/ai_prompt.txt
              echo "$AI_PROMPT" >> /tmp/ai_prompt.txt
              echo "" >> /tmp/ai_prompt.txt
              echo "---" >> /tmp/ai_prompt.txt
              echo "" >> /tmp/ai_prompt.txt
              ISSUE_NUM=$((ISSUE_NUM + 1))
            fi
          done

          # Check if we got any prompts
          if [ ! -s /tmp/ai_prompt.txt ] || [ "$(wc -l < /tmp/ai_prompt.txt)" -lt 3 ]; then
            echo "‚ö†Ô∏è Could not extract AI prompts, using full comments as context"
            cat /tmp/all_comments.json | jq -rs '.[] | "## Comment\n\(.body)\n\n---\n"' > /tmp/ai_prompt.txt
          fi

          echo "has_prompt=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Successfully extracted all AI prompts"
          echo ""
          echo "üìù Combined prompt content:"
          cat /tmp/ai_prompt.txt

      # ============================================
      # PHASE 2: Process with AI Agent (Claude)
      # ============================================
      - name: Setup Node.js
        if: steps.extract.outputs.has_prompt == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        if: steps.extract.outputs.has_prompt == 'true'
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Process with Claude Agent
        if: steps.extract.outputs.has_prompt == 'true'
        id: claude
        run: |
          echo "ü§ñ Processing review with Claude..."

          # Create a comprehensive prompt for Claude
          cat > /tmp/claude_task.txt << 'TASK_EOF'
          You are an AI code assistant. Your task is to fix ALL code issues based on a code review.
          There are MULTIPLE issues to fix - make sure you address ALL of them.

          CodeRabbit Review Issues:
          ========================
          TASK_EOF

          cat /tmp/ai_prompt.txt >> /tmp/claude_task.txt

          cat >> /tmp/claude_task.txt << 'TASK_EOF'

          ========================

          IMPORTANT INSTRUCTIONS:
          1. Read ALL the file(s) mentioned in the reviews
          2. Fix ALL issues described above - there may be multiple issues
          3. Make the MINIMAL fix to address each issue
          4. Do NOT add comments, documentation, or make unrelated changes
          5. If code is dead/unused, remove it entirely

          Apply ALL fixes now.
          TASK_EOF

          echo "üìã Task for Claude:"
          cat /tmp/claude_task.txt

          # Run Claude Code in agentic mode (NOT --print mode which is read-only)
          # --dangerously-skip-permissions: auto-approve all tool calls for CI
          # NOTE: -p/--print is READ-ONLY mode, we must NOT use it
          # The prompt is passed as a positional argument
          echo "üöÄ Running Claude Code agent..."
          claude --dangerously-skip-permissions "$(cat /tmp/claude_task.txt)" 2>&1 | tee /tmp/claude_output.txt || true

          echo ""
          echo "üìÑ Claude output:"
          cat /tmp/claude_output.txt

          # Check if any files were modified
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No changes were made by Claude"
            echo "Debug: Checking working directory status..."
            git status
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Claude made changes to the codebase"
            git diff --stat
            git diff
          fi

      # ============================================
      # PHASE 3: Create PR with Fixes
      # ============================================
      - name: Create Fix Branch and PR
        if: steps.claude.outputs.has_changes == 'true'
        env:
          PR_NUMBER: ${{ steps.pr_info.outputs.pr_number }}
          FEATURE_BRANCH: ${{ steps.pr_info.outputs.head_ref }}
        run: |
          echo "üîß Creating fix branch and PR..."

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create a unique branch name for the fix
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          FIX_BRANCH="ai-fix/${FEATURE_BRANCH}-${TIMESTAMP}"

          echo "üìå Creating branch: $FIX_BRANCH"
          git checkout -b "$FIX_BRANCH"

          # Stage and commit all changes
          git add -A
          git commit -m "fix: Apply CodeRabbit review suggestions

          Automated fixes based on CodeRabbit AI review.
          Original PR: #$PR_NUMBER

          Co-authored-by: Claude <noreply@anthropic.com>"

          # Push the fix branch
          git push origin "$FIX_BRANCH"

          # Create PR against the feature branch (not main)
          PR_BODY=$(cat << EOF
          ## ü§ñ Automated Fix PR

          This PR contains automated fixes based on [CodeRabbit's review](https://github.com/${{ github.repository }}/pull/${PR_NUMBER}#issuecomment-${{ github.event.comment.id }}) suggestions.

          ### Changes Made
          $(git diff HEAD~1 --stat)

          ### Original Review
          <details>
          <summary>Click to expand CodeRabbit's suggestions</summary>

          $(cat /tmp/ai_prompt.txt)

          </details>

          ---

          **Target Branch:** \`$FEATURE_BRANCH\`
          **Original PR:** #$PR_NUMBER

          > Please review these changes and merge if they look correct.
          EOF
          )

          # Create the PR targeting the feature branch
          gh pr create \
            --title "fix: CodeRabbit review fixes for #$PR_NUMBER" \
            --body "$PR_BODY" \
            --base "$FEATURE_BRANCH" \
            --head "$FIX_BRANCH"

          echo "‚úÖ Fix PR created successfully!"

      - name: Comment on Original PR
        if: steps.claude.outputs.has_changes == 'true'
        env:
          PR_NUMBER: ${{ steps.pr_info.outputs.pr_number }}
        run: |
          # Get the newly created PR URL
          FIX_PR_URL=$(gh pr list --head "ai-fix/" --json url -q '.[0].url' || echo "")

          COMMENT="ü§ñ **AI Fix Generated**

          I've analyzed the CodeRabbit review and created a fix PR with the suggested changes.

          üëâ **Fix PR:** $FIX_PR_URL

          Please review the changes and merge if they look correct."

          gh pr comment "$PR_NUMBER" --body "$COMMENT"

      - name: No Changes Summary
        if: steps.extract.outputs.has_prompt == 'true' && steps.claude.outputs.has_changes != 'true'
        env:
          PR_NUMBER: ${{ steps.pr_info.outputs.pr_number }}
        run: |
          echo "‚ÑπÔ∏è No automated changes were made"

          COMMENT="ü§ñ **AI Review Analysis**

          I analyzed the CodeRabbit review but couldn't automatically apply fixes. This might be because:
          - The suggestions require manual review
          - The changes are architectural in nature
          - The code context wasn't sufficient

          Please review the suggestions manually."

          gh pr comment "$PR_NUMBER" --body "$COMMENT"
