name: Process CodeRabbit Reviews

on:
  # Use only one trigger - CodeRabbit uses issue_comment for AI prompts
  issue_comment:
    types: [created]

jobs:
  analyze-coderabbit-comment:
    # Only run if the comment is from CodeRabbit AND has AI prompt
    if: |
      github.event.comment.user.login == 'coderabbit[bot]' &&
      contains(github.event.comment.body, 'ðŸ¤– Prompt for AI Agents')
    
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      - name: Extract AI Prompt
        id: extract
        env:
          COMMENT: ${{ github.event.comment.body }}
        run: |
          # More precise extraction of the AI prompt
          echo "ðŸ” Extracting AI prompt from CodeRabbit..."
          
          # Get everything between the code block markers after "ðŸ¤– Prompt for AI Agents"
          AI_PROMPT=$(echo "$COMMENT" | 
            sed -n '/ðŸ¤– Prompt for AI Agents/,/^```$/p' |  # Get section
            sed -n '/^```$/,/^```$/p' |                     # Get just code block
            sed '1d;$d')                                    # Remove the ``` markers
          
          if [ -n "$AI_PROMPT" ]; then
            echo "âœ… Extracted AI prompt:"
            echo "$AI_PROMPT"
            echo "$AI_PROMPT" > ai_task.txt
            echo "has_prompt=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ No AI prompt found"
            echo "has_prompt=false" >> $GITHUB_OUTPUT
          fi

      - name: Process AI Task
        if: steps.extract.outputs.has_prompt == 'true'
        run: |
          echo "ðŸš€ Processing AI task:"
          cat ai_task.txt
          echo ""
          echo "ðŸ‘‰ Next: Send this to Claude API"
